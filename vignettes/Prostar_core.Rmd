---
title: "Prostar core"
subtitle: "A developer's guidelines"
author: "Samuel Wieczorek"
date: "01/07/2020"
output: 
  BiocStyle::html_document:

    keep_md: true
    papersize: a4
vignette: >
  %\VignetteIndexEntry{Prostar core}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = TRUE,
                      comment = "#>")
```


```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
```


# Introduction

This vignette aims to describe the core code of Prostar and is addressed to developers. It describes how
Prostar works in terms of information system and how it is built.
This document is written as a tutorial to be followed step-by-step in order to understand the different parts of the shiny app.

Prostar is thought to be as much generic as possible. This has the great advantage to be easier for a developer to implement new process modules and new pipelines. The counterpart of this feature is that the code of the core part maybe be a bit complex to understand due to the heavy use of variables.
This is why the nomenclature is extremely important when coding Prostar 

This is also another reason for that tutorial made step-by-step


# Description of the package Prostar

Prostar is built with the [golem] package.


# Step 1. A simple Shiny App

Prostar is buil with the shiny framework and use the 'navbar page menu' layout. Previous versions of Prostar used other layouts (such as xxx) but the free space on the screen was too small to put all the outputs.

First, let write a simple A

# Generalities


## Contraints on the managment of modules

* un process prend en entree un dataset de 'n' items et renvoie un dataset de (n+1) items
* par defaut, l'indice courant est placé sur le dernier item du dataset. De la sorte, on modifie toujours le dernier item et on rajoute ainsi un nouvel item à la liste
* pour un processus donné, si l'indice courant i n'est pas positionné  sur le dernier élément (i < N) alors, on supprime tous les items suivant (de i+1 à N) puis on procède à l'ajout du nouvel élément. 
* on ne peut pas exécuter 2 fois de suite le même processus
* a l'affichage de l'UI d'un processus déjà exécuté auparavant:
  * si l'indice courant i est positionné sur le dernier élément du dataset, alors affichage du début du processus,
  * si i est positionné sur un dataset précédent (i < N) (le dataset déjà traité par ce processus), alors on n'affiche que la dernière page du processus


## Nomenclature 


All the files containing code are stored in the directory R.
The modules are prefixed with 'mod_'



## Test modules

Each module in the directory 'R' has a test file, located in 'dev/test_dev'.



## Workflow files

In each directory of a workflow, there are several type of files (module source code, watch modules code, miscellaneous code).
As those files are dynamically loaded in Prostar (and not at the same time), it is necessary to identify in a unique
manner each file with its function. Two ways are possible to do that:
* build a complex hierarchy of directories in which directory correspond to a specific function,
* name each source code file with a complex name

Actually, Prostar's files structure uses the second point. In the directory of a workflow, the module's files are composed of four strings separated by a '_':
* 'mod' which is the prefix used by the package [golem] to identify the modules,
* the name of the workflow. It seems obvious because we are in the directory of the wf but it is more for the eyes of the developer and for make easiest the reading of the name of the files,
* the name of the process itself.

For the files containing the code to launch the server part of each module, we have prefixed the names by 'watch_'



# UI side

The code for the ui side of Prostar is in the file 'R/app_ui.R'. It consists in two main parts:
* a loading page (div id = 'loading_page'),
* the ui of Prostar ('main_content')

It is based on the navbarPage layout (see xxx) in the shiny package. There are several static menus (and submenus) that are present even if no dataset is loaded:

* **Prostar**:
  * Home: 
  * Global settings:
  * Release notes:
  * Check for updates
* **Data manager**:
  * Open MSnset: ui to open a dataset previously created by the user,
  * Convert: through several steps, converts Excel or CSV files containing quantitative data to an object of class QFeatures,
  which is the format admitted in Prostar,
  * Demo data
  * Reload Prostar
* **Data processing**:
  * Descriptive statistics:
* **Help**:
  * Links:
  * FAQ:
  * Bug report

All of these submenus are implemented as modules : there ui parts are called her and their server part are called from the server side of Prostar (R/app_server.R).





# Server side

The code for the server side of Prostar is in the file 'R/app_server.R'.

## Declaration of global reactive variables


## Call to server modules

The server-side of all the modules which ui are declared in the app_ui.R file are called in this file.


# Load a dataset and corresponding modules

Once a dataset is loaded in prostar (the variable xxx is instanciated), Prostar launches the different modules that are part of the pipeline previously choosen by the user.
The list of modules in that pipeline are stored in the file 'config.R'

## Config.R

This file contains the definition of pipelines, ie the list of processing modules included in the pipeline. For example, here is the definition for the protein pipeline.

```{r ui, eval=FALSE}
pipeline.defs <- list(
  protein = c('Filtering',
              'Normalization',
              'Imputation')
)
}
```

If a developer wants to implement a new pipeline, he has to complete the definition while respecting the nomenclature of the items of the list. This is very important since Prostar maps theses names with source code files.


